---
name: hk-momentum-tracker
description: 港股 AI 概念股资金阶段识别与交易策略 - 识别泡沫周期、资金强度、情绪阶段
argument-hint: <股票代码> [--history] [--daily]
allowed-tools: WebSearch, WebFetch, Bash
model: opus
user-invocable: true
---

# 执行步骤（必须按顺序执行）

## Step 0：获取真实数据（必须首先执行）

**在进行任何分析之前，必须先运行数据抓取脚本获取真实行情数据：**

```bash
python3 {SKILL_DIR}/fetch_data.py <股票代码>
```

**示例：**
```bash
python3 {SKILL_DIR}/fetch_data.py 00020
```

脚本会返回 JSON 格式的数据，包含：
- 上市以来所有历史数据统计
- 成交额/换手率分位数
- 阶段信号计算结果（加速/分歧/破位）
- 资金强度评分
- 最近 20 个交易日详细数据
- 成交额 Top 10 交易日

**获取数据后，基于返回的 JSON 数据进行后续分析。禁止编造数据。**

---

# HK Momentum Tracker - 港股 AI 概念股资金阶段追踪

## 核心交易哲学

**这不是估值钱，不是基本面钱。**

你要赚的是：

```
叙事升级 × 流动性挤压 × 资金拥挤加速
```

**利润来源的四个维度：**

| 维度 | 机制 | 表现 |
|------|------|------|
| 预期重估 | 市场对公司定位升级 | 突破历史估值区间 |
| 仓位集中 | 资金从分散→拥挤 | 成交额持续放大 |
| 供给锁死 | 流通盘小+惜售 | 卖盘稀薄，价格跳升 |
| 情绪正反馈 | 涨→更多人买→涨 | 连续阳线，回撤极浅 |

**你要抓的是：**
```
趋势中段 → 加速初段 的非线性斜率
```

---

## 大行情的结构特征

回看历史（AI/新能源/半导体），大行情的共同结构：

```
阶段 1：突破盘整区（确认信号）
    ↓
阶段 2：连续放量上涨（主升浪）
    ↓
阶段 3：回撤极小（< 20%）（强势确认）
    ↓
阶段 4：加速（斜率陡峭化）
    ↓
阶段 5：情绪爆发（顶部区域）
```

**大行情的核心特征：**
```
回调很浅，犹豫就上不去。
```

**关键认知：**
- 抓大行情的合适入场点，从来不是"舒服回调"
- 而是：**突破确认后的第一次延续**

---

## 适用场景

针对港股上市的 AI Native 公司（大模型、AI 应用等），这类股票特点：
- 流通盘小，筹码集中
- Q1 财报前无基本面锚定，纯粹炒叙事
- 情绪面与事件高度相关
- 资金博弈特征明显

**核心目标：识别大行情结构，在正确的阶段执行正确的操作**

你的任务不是罗列数据，而是回答三个核心问题：
1. **当前处于大行情的哪个阶段？**（盘整/突破/主升/加速/情绪爆发）
2. **叙事是否被市场验证？**（资金确认）
3. **基于当前阶段，仓位应该如何设计？**

任何一段分析，如果不能明确对应上述某一问题，都是冗余的。删掉它。

---

## 模式判断

- `--history`：**全量历史复盘模式**，分析上市以来所有价格、成交量、换手率数据，深度复盘资金面和市场博弈
- `--daily`：每日总结模式，输出当日资金状态和操作建议
- 默认：综合分析，输出当前阶段判断和策略

---

## 写作规范：禁止碎点堆砌

**每个段落必须承载一个完整论证链，包含以下四个要素：**

| 要素 | 说明 | 示例 |
|------|------|------|
| **① 事实** | 引用关键数据（必须有具体数字） | "2月20日成交额 48.7 亿港元" |
| **② 基准** | 与历史/均值/阈值对比 | "为 20 日均值 12.3 亿的 3.96 倍，创上市以来新高" |
| **③ 机制** | 解释为什么（归因到事件或资金行为） | "当日 DeepSeek 发布 R2 模型，市场将商汤视为国产算力替代标的" |
| **④ 边界** | 结论到哪里为止 + 后续验证条件 | "这确认进入加速段，但若次日成交额萎缩至 20 亿以下且收阴，则加速段可能终结" |

**强制规则：**

- 若某段只有数据没有对比，或只有结论没有依据，必须补全
- 禁止使用 bullet point 列举 5 个以上并列信息——超过 3 个必须分组并给出小结
- 每个论证段落结尾必须有明确的"因此"、"这意味着"或"但是"转折，指向下一步推理
- 所有数据必须标注来源和日期

**反面示例（禁止）：**
```
- 成交额 48 亿
- 换手率 35%
- 涨幅 18%
- 创历史新高
- 振幅 25%
```

**正面示例（要求）：**
```
2月20日商汤收涨 18.3%，成交额 48.7 亿港元，为 20 日均值（12.3 亿）的 3.96 倍，
创上市以来单日成交额新高。放量主因是 DeepSeek R2 发布后市场重估国产算力需求，
商汤作为 AI 算力龙头获资金追捧。换手率达 35.2%，接近历史极值（P99 = 38%），
这意味着筹码在高位快速换手，短期目标空间有限。若次日成交额萎缩至 20 亿以下且收阴，
则确认进入分歧段；若继续放量创新高，加速段延续但风险同步累积。
```

---

## 数据来源与获取规范

**原则：数据必须可追溯，禁止编造。找不到就说找不到。**

### 一、港股行情数据（必须获取）

**优先级 1：AKShare API（最准确）**

```python
import akshare as ak
import pandas as pd

# 获取港股完整历史数据
# symbol: 股票代码，如 "00020"（商汤）
df = ak.stock_hk_hist(symbol="00020", period="daily", adjust="qfq")

# 返回字段：
# 日期, 开盘, 收盘, 最高, 最低, 成交量, 成交额, 振幅, 涨跌幅, 涨跌额, 换手率

# 数据验证：检查数据完整性
print(f"数据起始日期: {df['日期'].min()}")
print(f"数据结束日期: {df['日期'].max()}")
print(f"总交易日数: {len(df)}")
print(f"缺失值检查: {df.isnull().sum()}")
```

**优先级 2：东方财富（Web 抓取）**

搜索: "[股票代码] 历史行情 东方财富"
URL: `https://quote.eastmoney.com/hk/[股票代码].html`

**优先级 3：新浪财经**

搜索: "[股票代码] K线数据 新浪港股"
URL: `https://stock.finance.sina.com.cn/hkstock/quotes/[股票代码].html`

### 二、流通市值数据（必须获取）

| 来源 | 搜索方式 | 数据字段 |
|------|----------|----------|
| 富途牛牛 | "[股票代码] 流通市值 富途" | 流通股本、流通市值 |
| 雪球 | "[股票代码] 股本结构 雪球" | 总股本、流通股 |
| 东方财富 | "[股票代码] 股本 东方财富" | 流通市值 |

**流通市值计算验证：**
```
流通市值 = 流通股本 × 当前股价
换手率验证 = 成交额 ÷ 流通市值 × 100%
```

### 三、事件数据（用于归因）

**必须搜索的事件来源：**

| 事件类型 | 搜索方式 | 来源 |
|----------|----------|------|
| 公司公告 | "[股票代码] 公告" site:hkexnews.hk | 港交所披露易 |
| 行业新闻 | "[公司名] OR [行业关键词]" site:cls.cn | 财联社 |
| 政策事件 | "[公司名] 政策" site:wallstreetcn.com | 华尔街见闻 |
| AI 行业事件 | "DeepSeek OR OpenAI OR 大模型" site:36kr.com | 36氪 |
| 市场情绪 | "[股票代码]" site:xueqiu.com | 雪球讨论 |

**事件归因规范：**

对于每个关键交易日（成交额/涨跌幅异常），必须：
1. 搜索当日及前一日的相关新闻
2. 判断事件与股价变动的因果关系
3. 如无明确事件，标注"无明确事件触发，推测为[技术面/资金面/情绪面]驱动"

---

## 指标计算公式定义

### 一、基础指标

**1. N日涨跌幅**
```
R(n) = (P_t - P_{t-n}) / P_{t-n} × 100%

其中：
- P_t = 当日收盘价
- P_{t-n} = n 日前收盘价
```

**2. N日移动平均线**
```
MA(n) = Σ(P_{t-i}) / n, i = 0 to n-1

其中：
- P_{t-i} = 第 t-i 日收盘价
```

**3. 最大回撤**
```
MDD = (P_peak - P_trough) / P_peak × 100%

其中：
- P_peak = 区间内最高价
- P_trough = P_peak 之后的最低价
```

**4. 换手率**
```
Turnover = Volume / Float_Shares × 100%
或
Turnover = Turnover_Amount / Float_Market_Cap × 100%

其中：
- Volume = 成交量（股）
- Float_Shares = 流通股本
- Turnover_Amount = 成交额（港元）
- Float_Market_Cap = 流通市值
```

**5. 振幅**
```
Amplitude = (P_high - P_low) / P_{t-1_close} × 100%

其中：
- P_high = 当日最高价
- P_low = 当日最低价
- P_{t-1_close} = 前一日收盘价
```

### 二、衍生指标

**6. 成交额比率（Volume Ratio）**
```
VR(n) = V_t / MA_V(n)

其中：
- V_t = 当日成交额
- MA_V(n) = n 日成交额均值
```

**7. 价格斜率（线性回归）**
```
Slope_P(n) = Σ[(i - i_mean)(P_i - P_mean)] / Σ[(i - i_mean)²]

其中：
- n = 计算周期（通常 10 日）
- i = 时间序号
- P_i = 第 i 日收盘价
```

**8. 成交额斜率**
```
Slope_V(n) = Σ[(i - i_mean)(V_i - V_mean)] / Σ[(i - i_mean)²]

其中：
- V_i = 第 i 日成交额
```

**9. 上影线比率**
```
Upper_Shadow_Ratio = (P_high - P_close) / (P_high - P_low)

判断标准：
- > 0.6：长上影线（抛压重）
- 0.3-0.6：中等上影
- < 0.3：无明显上影
```

**10. 累计换手率**
```
Cumulative_Turnover = Σ(Daily_Turnover_i), i = 上市日 to 当前

含义：
- 100% = 流通盘完全换手一次
- 300% = 相当于换手 3 次
```

### 三、阶段判断指标

**11. 加速段信号计数**
```
Acceleration_Score = count(满足条件)

条件列表：
- R(10) > 120%
- R(5) > 50%
- 连续创新高天数 ≥ 3
- V_t = max(V, 60日)
- MDD(20) < 15%

判断：Score ≥ 3 → 加速段
```

**12. 分歧段信号计数**
```
Distribution_Score = count(满足条件)

条件列表：
- Amplitude_t > MA_Amplitude(20) × 1.5
- Upper_Shadow_Ratio > 0.6
- V_t = max(V, history) 且 |R_t| < 5%
- 连续 2 日 P_close < P_high × 0.95
- 板块其他股启动

判断：Score ≥ 3 → 分歧段
```

**13. 破位段信号计数**
```
Breakdown_Score = count(满足条件)

条件列表：
- (P_peak - P_t) / P_peak > 30%
- P_t < MA(20)
- V_t > MA_V(20) 且 R_t < 0

判断：Score ≥ 2 → 破位段
```

**14. 资金强度评分**
```
Strength_Score =
  0.30 × normalize(VR(5)/VR(20)) +
  0.25 × normalize(Turnover_t) +
  0.25 × normalize(Slope_P(10)) +
  0.20 × normalize(新高频率)

其中：
- normalize() = 将值映射到 0-100 区间
- 新高频率 = 近 10 日创新高天数 / 10
```

**15. 泡沫能量指标**
```
Bubble_Energy = sign(Slope_P) × sign(Slope_V) × sign(Event_Freq)

状态判断：
- (+,+,+) → 泡沫能量增强期
- (+,-,any) → 泡沫衰退期（量价背离）
- (-,+,any) → 泡沫破裂期（恐慌抛售）
```

---

## 数据验证规范

**执行计算前必须验证：**

### 1. 数据完整性检查
```python
# 检查交易日连续性
df['日期'] = pd.to_datetime(df['日期'])
date_diff = df['日期'].diff().dt.days
gaps = date_diff[date_diff > 4]  # 超过 4 天可能有问题（考虑假期）
if len(gaps) > 0:
    print(f"警告：数据可能有缺失，异常间隔：{gaps}")
```

### 2. 数值合理性检查
```python
# 检查异常值
assert df['涨跌幅'].between(-50, 100).all(), "涨跌幅存在异常值"
assert df['换手率'].between(0, 100).all(), "换手率存在异常值"
assert (df['最高'] >= df['收盘']).all(), "最高价应 >= 收盘价"
assert (df['最低'] <= df['收盘']).all(), "最低价应 <= 收盘价"
```

### 3. 计算结果交叉验证
```
验证换手率：
计算值 = 成交额 / 流通市值
数据源值 = df['换手率']
误差 = |计算值 - 数据源值| / 数据源值
若误差 > 10%，需检查流通市值数据是否正确
```

---

## 核心分析框架

### Skill 1：资金阶段识别（Regime Detection）

**阶段定义与判断逻辑：**

```
执行顺序（优先级从高到低）：

1. 检测破位段（BREAKDOWN）
   IF Breakdown_Score ≥ 2:
       阶段 = BREAKDOWN

2. 检测分歧段（DISTRIBUTION）
   ELIF Distribution_Score ≥ 3:
       阶段 = DISTRIBUTION

3. 检测加速段（PARABOLIC_ACCELERATION）
   ELIF Acceleration_Score ≥ 3:
       阶段 = PARABOLIC_ACCELERATION

4. 检测主升段（MOMENTUM）
   ELIF R(20) > 50% AND MDD(20) < 25%:
       阶段 = MOMENTUM

5. 默认横盘/筑底
   ELSE:
       阶段 = CONSOLIDATION
```

### Skill 2：事件归因分析

**每个关键交易日必须完成事件归因：**

```
关键交易日定义：
- 成交额 > P90（90%分位数）
- |涨跌幅| > 10%
- 换手率 > 25%
- 创历史新高或新低

归因流程：
1. 搜索当日新闻：
   "[公司名] [日期]" site:cls.cn
   "[公司名] [日期]" site:wallstreetcn.com

2. 搜索前一日新闻（盘后消息）：
   "[公司名] [前一日日期]" site:hkexnews.hk

3. 搜索行业事件：
   "AI 大模型 [日期]" site:36kr.com
   "DeepSeek OR OpenAI [日期]"

4. 归因判断：
   - 若有明确事件 → 事件驱动
   - 若无明确事件但板块联动 → 板块轮动
   - 若无明确事件且独立走势 → 资金行为（主力操作）
```

### Skill 3：资金强度评分

**计算步骤：**

```python
def calculate_strength_score(df, float_market_cap):
    """
    计算资金强度评分（0-100）
    """
    # 1. 成交额趋势分（30%）
    vr_5 = df['成交额'].tail(5).mean()
    vr_20 = df['成交额'].tail(20).mean()
    volume_score = min(100, (vr_5 / vr_20) * 50)  # 2倍得100分

    # 2. 换手率分（25%）
    turnover_today = df['成交额'].iloc[-1] / float_market_cap * 100
    turnover_score = min(100, turnover_today * 3.33)  # 30%得100分

    # 3. 价格斜率分（25%）
    prices = df['收盘'].tail(10).values
    x = np.arange(10)
    slope = np.polyfit(x, prices, 1)[0]
    slope_pct = slope / prices[0] * 100  # 日均涨幅%
    slope_score = min(100, max(0, slope_pct * 10 + 50))  # 5%日均得100分

    # 4. 创新高频率分（20%）
    highs = df['收盘'].tail(10)
    new_high_count = sum(highs == highs.cummax())
    high_score = new_high_count * 10

    # 加权汇总
    total_score = (
        volume_score * 0.30 +
        turnover_score * 0.25 +
        slope_score * 0.25 +
        high_score * 0.20
    )

    return round(total_score, 1)
```

### Skill 4：换手率预警

**阈值定义：**

| 换手率区间 | 状态 | 含义 | 操作建议 |
|------------|------|------|----------|
| < 10% | 正常 | 筹码稳定 | 可持有 |
| 10-20% | 活跃 | 资金关注 | 关注 |
| 20-30% | 亢奋 | 情绪高涨 | 谨慎加仓 |
| > 30% | 极端 | 接近极值 | 不追高，考虑减仓 |

**极端换手预警逻辑：**
```
IF 换手率 > 30% 连续 2 日以上:
    预警级别 = 高
    含义 = "筹码高度换手，情绪极值，短期顶部概率大"
```

### Skill 5：事件驱动交易策略（核心执行框架）

**这是生产级策略，直接影响收益。必须严格执行。**

#### 策略核心逻辑

```
AI 概念股的核心驱动力是【事件】，不是基本面。
策略本质：用小仓位押注事件催化，用纪律管理加速段风险。
```

#### 阶段一：事件前（PRE-EVENT）

**触发条件：**
- 已知重大事件即将发生（模型发布会、财报、政策发布等）
- 判断该事件可能带来行业震动

**执行策略：**
```
仓位：10-20%（绝对上限 20%）
定位：期权式仓位
逻辑：亏损有限（最多亏 20% × 回撤），但若事件催化，收益弹性大

入场条件：
- 股价未提前大幅上涨（事件前 5 日涨幅 < 30%）
- 成交额处于正常区间（< P75）
- 换手率 < 20%

止损设置：
- 硬止损：-15%（绝对止损，不可突破）
- 事件落空止损：若事件发生但股价未反应（次日涨幅 < 5%），减仓至 5%
```

**事件前检查清单：**
```python
def check_pre_event_entry(df, event_date):
    """
    检查是否满足事件前入场条件
    返回: (可入场: bool, 建议仓位: float, 原因: str)
    """
    # 事件前 5 日涨幅
    pre_event_return = calculate_return(df, 5, event_date)
    if pre_event_return > 30:
        return (False, 0, f"事件前涨幅已达 {pre_event_return:.1f}%，已透支预期")

    # 成交额分位
    recent_volume = df.loc[event_date - 5:event_date, '成交额'].mean()
    volume_percentile = percentile_rank(recent_volume, df['成交额'])
    if volume_percentile > 75:
        return (False, 0, f"成交额处于 P{volume_percentile}，资金已提前入场")

    # 换手率
    recent_turnover = df.loc[event_date - 5:event_date, '换手率'].mean()
    if recent_turnover > 20:
        return (False, 0, f"换手率 {recent_turnover:.1f}%，筹码已活跃")

    # 建议仓位（根据确定性调整）
    position = 15  # 默认 15%
    if pre_event_return < 10 and volume_percentile < 50:
        position = 20  # 条件好，可用上限

    return (True, position, "满足入场条件")
```

#### 阶段二：事件当天（EVENT DAY）

**核心观察指标（必须同时满足才加仓）：**

```
指标 1：放量突破
- 成交额 > 20 日均值 × 2（即 VR > 2）
- 或成交额创近 60 日新高

指标 2：成为市场焦点
- 涨幅 > 10%
- 或盘中涨幅曾 > 15%
- 板块内涨幅领先

判断公式：
Event_Catalyst_Score = (VR > 2) + (涨幅 > 10%) + (板块领涨)

IF Event_Catalyst_Score >= 2:
    执行加仓
ELSE:
    维持原仓位或减仓
```

**执行策略：**
```
若满足加仓条件：
- 加仓至 30-40%
- 加仓时机：尾盘（14:30-16:00）确认趋势后
- 禁止追涨停板

若不满足加仓条件：
- 维持 10-20% 仓位
- 若次日继续走弱，减仓至 5%

事件当天止损：
- 若开盘冲高回落（日内高点回撤 > 10%）且收阴，减仓 50%
```

**事件当天决策代码：**
```python
def event_day_decision(df, today, pre_event_position):
    """
    事件当天的加仓决策
    返回: (操作: str, 目标仓位: float, 原因: str)
    """
    today_data = df.loc[today]

    # 计算 VR
    ma20_volume = df['成交额'].rolling(20).mean().loc[today]
    vr = today_data['成交额'] / ma20_volume

    # 检查是否 60 日新高
    is_60d_high = today_data['成交额'] == df['成交额'].tail(60).max()

    # 涨幅
    return_today = today_data['涨跌幅']

    # 计算催化得分
    score = 0
    reasons = []

    if vr > 2 or is_60d_high:
        score += 1
        reasons.append(f"放量（VR={vr:.1f}）")

    if return_today > 10:
        score += 1
        reasons.append(f"大涨（+{return_today:.1f}%）")

    # 判断
    if score >= 2:
        target = min(40, pre_event_position + 20)
        return ("加仓", target, f"事件催化确认：{', '.join(reasons)}")
    elif return_today < 0:
        return ("减仓", pre_event_position * 0.5, "事件落空，股价下跌")
    else:
        return ("持有", pre_event_position, "催化不明显，观望")
```

#### 阶段二B：进攻型入场点（AGGRESSIVE ENTRY）

**核心认知：大行情的入场点，不是"舒服回调"**

```
██████████████████████████████████████████████████████████████████████
█                                                                    █
█   大行情回调很浅，犹豫就上不去。                                      █
█   合适的入场点是：突破确认后的第一次延续。                             █
█                                                                    █
██████████████████████████████████████████████████████████████████████
```

**入场必须满足的三个条件：**

##### 条件一：叙事被市场验证（资金确认）

```
不是你自己觉得好，而是市场确认了。

资金确认的三个信号：
✓ 放量突破（成交额 > P90 或创阶段新高）
✓ 创阶段新高（突破前期高点）
✓ 成为市场焦点（板块领涨、媒体热议）

判断公式：
Market_Validation_Score = (放量突破) + (创阶段新高) + (成为焦点)

IF Market_Validation_Score >= 2:
    叙事被市场验证 = True
ELSE:
    叙事未验证，不入场
```

**验证代码：**
```python
def check_market_validation(df, today):
    """
    检查叙事是否被市场验证
    返回: (已验证: bool, 得分: int, 信号列表: list)
    """
    today_data = df.loc[today]
    signals = []
    score = 0

    # 1. 放量突破
    volume_p90 = df['成交额'].quantile(0.90)
    recent_max_volume = df['成交额'].tail(60).max()
    if today_data['成交额'] > volume_p90 or today_data['成交额'] >= recent_max_volume:
        score += 1
        signals.append(f"放量确认（成交额 {today_data['成交额']:.1f} 亿 > P90 {volume_p90:.1f} 亿）")

    # 2. 创阶段新高
    recent_high = df['收盘'].tail(60).max()
    if today_data['收盘'] >= recent_high * 0.98:  # 允许 2% 误差
        score += 1
        signals.append(f"价格确认（收盘 {today_data['收盘']:.2f} 创/接近阶段新高）")

    # 3. 成为市场焦点（涨幅领先）
    if today_data['涨跌幅'] > 8:
        score += 1
        signals.append(f"焦点确认（涨幅 {today_data['涨跌幅']:.1f}%）")

    return (score >= 2, score, signals)
```

##### 条件二：回撤被迅速买回（强势确认）

```
这是区分"真突破"和"假突破"的关键信号。

示例：
- 单日跌 8%
- 第二天直接收回（涨 > 5% 或收复前日跌幅 50%+）
= 说明下方承接力强，资金在抢筹

判断公式：
IF 前日跌幅 > 5% AND 今日涨幅 > 前日跌幅 × 0.5:
    强势回补确认 = True
    可以加仓

IF 前日跌幅 > 5% AND 今日继续下跌:
    突破失败，减仓
```

**验证代码：**
```python
def check_pullback_recovery(df, today):
    """
    检查回撤是否被迅速买回
    返回: (强势回补: bool, 信号类型: str, 说明: str)
    """
    if len(df) < 2:
        return (False, "数据不足", "")

    today_data = df.loc[today]
    yesterday_data = df.iloc[-2]  # 前一日

    yesterday_return = yesterday_data['涨跌幅']
    today_return = today_data['涨跌幅']

    # 前日大跌
    if yesterday_return < -5:
        # 今日强势回补
        if today_return > abs(yesterday_return) * 0.5:
            return (True, "强势回补",
                    f"前日跌 {yesterday_return:.1f}%，今日涨 {today_return:.1f}%，"
                    f"回补 {today_return/abs(yesterday_return)*100:.0f}%")
        # 今日继续下跌
        elif today_return < 0:
            return (False, "突破失败",
                    f"前日跌 {yesterday_return:.1f}%，今日继续跌 {today_return:.1f}%，"
                    "承接力弱")
        else:
            return (False, "观望",
                    f"前日跌 {yesterday_return:.1f}%，今日涨 {today_return:.1f}%，"
                    "回补力度不足，继续观察")

    return (False, "无回撤", "近期无显著回撤")
```

##### 条件三：突破后第一次延续（时机选择）

```
入场时机不是：
✗ 等待深度回调（大行情不会给你）
✗ 突破当天追高（风险最大）

入场时机是：
✓ 突破确认后的第一次延续
✓ 即：突破日后 1-3 天，股价站稳突破位

判断逻辑：
Day 0: 突破日（放量创新高）
Day 1: 确认日（收盘 > 突破日收盘 × 0.95）
Day 2-3: 延续日 → 这是最佳入场点

入场条件：
- 突破后 1-3 日
- 收盘价站稳突破位（> 突破日收盘 × 0.95）
- 成交额未大幅萎缩（> 突破日成交额 × 0.5）
```

**最佳入场点判断代码：**
```python
def find_entry_point(df, breakout_date):
    """
    寻找突破后的最佳入场点
    返回: (可入场: bool, 入场类型: str, 建议仓位: float, 说明: str)
    """
    breakout_data = df.loc[breakout_date]
    breakout_price = breakout_data['收盘']
    breakout_volume = breakout_data['成交额']

    # 获取突破后的数据
    post_breakout = df.loc[breakout_date:].iloc[1:]  # 排除突破日

    if len(post_breakout) == 0:
        return (False, "等待", 0, "突破当天，等待确认")

    days_after = len(post_breakout)
    latest = post_breakout.iloc[-1]

    # 检查是否站稳突破位
    price_confirmed = latest['收盘'] > breakout_price * 0.95
    volume_confirmed = latest['成交额'] > breakout_volume * 0.5

    if days_after <= 3 and price_confirmed and volume_confirmed:
        # 最佳入场窗口
        if days_after == 1:
            return (True, "激进入场", 30,
                    f"突破后第 1 天确认，收盘 {latest['收盘']:.2f} > 突破位 {breakout_price*0.95:.2f}")
        else:
            return (True, "标准入场", 25,
                    f"突破后第 {days_after} 天延续，价格站稳")

    elif days_after <= 3 and not price_confirmed:
        return (False, "突破失败", 0,
                f"跌破突破位，收盘 {latest['收盘']:.2f} < {breakout_price*0.95:.2f}")

    elif days_after > 3:
        return (False, "窗口已过", 0,
                "突破后超过 3 天，错过最佳入场点，等待下一次机会")

    return (False, "观望", 0, "条件不完全满足")
```

#### 进攻型入场策略汇总

```
┌─────────────────────────────────────────────────────────────────────┐
│                        进攻型入场决策树                               │
└─────────────────────────────────────────────────────────────────────┘

                叙事被市场验证？
                (放量 + 新高 + 焦点)
                        │
            ┌───────────┴───────────┐
            ▼                       ▼
          YES                      NO
            │                       │
            ▼                       ▼
    处于突破后 1-3 天？            不入场
            │
            ▼
    站稳突破位？（>95%）
            │
    ┌───────┴───────┐
    ▼               ▼
   YES              NO
    │               │
    ▼               ▼
  入场            等待/放弃
  25-30%
            │
            ▼
    有回撤被买回信号？
            │
    ┌───────┴───────┐
    ▼               ▼
   YES              NO
    │               │
    ▼               ▼
  加仓至           维持仓位
  35-40%
```

**进入加速段的判断（复用 Skill 1 的加速段信号）：**
```
Acceleration_Score >= 3 → 确认进入加速段
```

**加速段策略（核心纪律）：**

```
██████████████████████████████████████████████████████████████████████
█                                                                    █
█   加速段铁律：停止加仓，只管理仓位                                    █
█                                                                    █
██████████████████████████████████████████████████████████████████████

原因：
- 加速段是最危险的阶段，单日振幅可达 20-30%
- 顶部无法预测，只能通过纪律管理
- 追高是亏损的主要来源
```

**加速段仓位管理规则：**

```
1. 仓位上限：锁定当前仓位，不得增加

2. 移动止盈（Trailing Stop）：
   止盈线 = 阶段最高价 × (1 - 回撤容忍度)

   回撤容忍度设置：
   - 加速第 1-3 天：允许 15% 回撤
   - 加速第 4-5 天：允许 12% 回撤
   - 加速第 6 天以上：允许 10% 回撤

   计算公式：
   IF 当前价 < 阶段最高价 × (1 - 回撤容忍度):
       触发止盈，减仓 50%

3. 分歧信号止盈：
   IF Distribution_Score >= 2:
       预警，准备减仓
   IF Distribution_Score >= 3:
       减仓 30-50%

4. 绝对止损：
   IF 距离阶段高点回撤 > 20%:
       清仓
```

**加速段管理代码：**
```python
def manage_acceleration_phase(df, today, entry_price, current_position, acceleration_days):
    """
    加速段仓位管理
    返回: (操作: str, 目标仓位: float, 止盈线: float, 原因: str)
    """
    today_data = df.loc[today]

    # 阶段最高价（从进入加速段开始计算）
    phase_high = df['最高'].tail(acceleration_days).max()
    current_price = today_data['收盘']

    # 计算回撤容忍度
    if acceleration_days <= 3:
        tolerance = 0.15
    elif acceleration_days <= 5:
        tolerance = 0.12
    else:
        tolerance = 0.10

    # 止盈线
    stop_profit_line = phase_high * (1 - tolerance)

    # 当前回撤
    drawdown = (phase_high - current_price) / phase_high

    # 判断
    if drawdown > 0.20:
        return ("清仓", 0, stop_profit_line, f"回撤 {drawdown*100:.1f}% > 20%，触发绝对止损")

    if current_price < stop_profit_line:
        new_position = current_position * 0.5
        return ("减仓50%", new_position, stop_profit_line,
                f"跌破移动止盈线 ${stop_profit_line:.2f}")

    # 检查分歧信号
    dist_score = calculate_distribution_score(df, today)
    if dist_score >= 3:
        new_position = current_position * 0.6
        return ("减仓40%", new_position, stop_profit_line,
                f"分歧信号 {dist_score}/5，主动减仓")
    elif dist_score >= 2:
        return ("预警", current_position, stop_profit_line,
                f"分歧信号 {dist_score}/5，准备减仓")

    return ("持有", current_position, stop_profit_line,
            f"加速第 {acceleration_days} 天，回撤 {drawdown*100:.1f}%")
```

#### 完整交易流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        事件驱动交易流程                               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ STEP 1: 事件识别                                                     │
│ • 是否有重大事件即将发生？                                            │
│ • 事件类型：模型发布/财报/政策/行业动态                               │
│ • 事件影响评估：高/中/低                                              │
└─────────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
            事件影响：高/中              事件影响：低
                    │                       │
                    ▼                       ▼
┌───────────────────────────┐    ┌───────────────────────────┐
│ STEP 2: 事件前入场检查     │    │ 不参与                      │
│ • 5日涨幅 < 30%？          │    └───────────────────────────┘
│ • 成交额 < P75？           │
│ • 换手率 < 20%？           │
└───────────────────────────┘
                    │
            ┌───────┴───────┐
            ▼               ▼
        全部满足         不满足
            │               │
            ▼               ▼
┌─────────────────┐  ┌─────────────────┐
│ 入场 10-20%      │  │ 不入场/等待      │
│ 止损设 -15%      │  │                 │
└─────────────────┘  └─────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│ STEP 3: 事件当天观察                                                 │
│ • 放量突破？（VR > 2 或 60日新高）                                    │
│ • 成为市场焦点？（涨幅 > 10%）                                        │
└─────────────────────────────────────────────────────────────────────┘
                    │
            ┌───────┴───────┐
            ▼               ▼
    催化得分 >= 2       催化得分 < 2
            │               │
            ▼               ▼
┌─────────────────┐  ┌─────────────────┐
│ 尾盘加仓至 30-40%│  │ 维持/减仓        │
└─────────────────┘  └─────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│ STEP 4: 持续监控 - 是否进入加速段？                                  │
│ Acceleration_Score >= 3?                                            │
└─────────────────────────────────────────────────────────────────────┘
                    │
            ┌───────┴───────┐
            ▼               ▼
        进入加速段       未进入加速段
            │               │
            ▼               ▼
┌─────────────────┐  ┌─────────────────┐
│ ████ 停止加仓 ████ │  │ 可继续加仓      │
│ 只管理仓位        │  │ 监控阶段信号    │
│ 设移动止盈        │  └─────────────────┘
│ 监控分歧信号      │
└─────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│ STEP 5: 加速段管理                                                   │
│ • 每日计算移动止盈线                                                 │
│ • 监控分歧信号（Distribution_Score）                                 │
│ • 触发条件 → 执行减仓/清仓                                           │
└─────────────────────────────────────────────────────────────────────┘
                    │
            ┌───────┼───────┐
            ▼       ▼       ▼
      回撤>20%  跌破止盈线  分歧>=3
            │       │       │
            ▼       ▼       ▼
         清仓    减仓50%   减仓40%
```

#### 策略执行输出模板

**每日输出必须包含：**

```
═══════════════════════════════════════════════════════════════════════

策略执行状态
───────────────────────────────────────────────────────────────────────

当前阶段：[PRE-EVENT / EVENT_DAY / POST-EVENT / ACCELERATION / DISTRIBUTION / BREAKDOWN]
持仓状态：X%
持仓成本：$X
当前盈亏：+X%（$Y）

───────────────────────────────────────────────────────────────────────

今日决策
───────────────────────────────────────────────────────────────────────

【操作指令】
操作：[买入/加仓/持有/减仓/清仓]
目标仓位：X%
执行价格区间：$X - $Y
执行时机：[开盘/盘中/尾盘]

【决策依据】（按事实→基准→机制→边界格式）
[详细论述为什么做出这个决策，必须有数据支持]

───────────────────────────────────────────────────────────────────────

风控参数
───────────────────────────────────────────────────────────────────────

止损线：$X（触发条件：[具体描述]）
止盈线：$X（触发条件：[具体描述]）
预警线：$X（触发条件：[具体描述]）

下一决策点：[具体时间或条件]

═══════════════════════════════════════════════════════════════════════
```

### Skill 6：阶段汇总策略表

| 阶段 | 仓位范围 | 操作 | 止损 | 止盈 | 核心纪律 |
|------|----------|------|------|------|----------|
| PRE-EVENT | 10-20% | 小仓位入场 | -15% | - | 当作期权，亏损有限 |
| EVENT_DAY | 30-40% | 确认催化后加仓 | 日内回撤>10%减半 | - | 尾盘加仓，不追涨停 |
| POST-EVENT | 30-50% | 持有观察 | -20% | +50% | 等待确认是否进入加速 |
| ACCELERATION | 锁定当前 | **禁止加仓** | 移动止盈 | 回撤触发 | 只管理，不加仓 |
| DISTRIBUTION | 减至20% | 减仓30-50% | 跌破5日线 | - | 保护利润优先 |
| BREAKDOWN | 0% | 清仓 | - | - | 不抄底，等右侧 |

---

## 输出格式

### 历史复盘模式（--history）- 全量深度分析

```
[股票代码/公司名] 上市以来全量资金复盘

══════════════════════════════════════════════════════════════════════

第一部分：基础数据概览
──────────────────────────────────────────────────────────────────────

上市信息：
• 上市日期：YYYY-MM-DD
• 发行价：$X
• 上市首日收盘：$Y（较发行价 +Z%）

价格统计（数据来源：[来源]，截至 YYYY-MM-DD）：
• 当前价格：$X
• 历史最高：$H（YYYY-MM-DD）
• 历史最低：$L（YYYY-MM-DD）
• 上市至今涨幅：+X%
• 最大回撤：X%（从 $H 跌至 $L，日期范围）

成交统计：
• 累计成交额：$X 亿港元
• 日均成交额：$X 亿港元
• 成交额 P50（中位数）：$X 亿
• 成交额 P90：$X 亿
• 成交额 P99：$X 亿
• 最大单日成交额：$X 亿（YYYY-MM-DD）

换手统计：
• 累计换手率：X%（相当于流通盘换手 X 次）
• 日均换手率：X%
• 换手率 P90：X%
• 最高单日换手率：X%（YYYY-MM-DD）

══════════════════════════════════════════════════════════════════════

第二部分：完整行情阶段划分
──────────────────────────────────────────────────────────────────────

【阶段 1】YYYY-MM-DD 至 YYYY-MM-DD - [阶段名称]

阶段数据：
• 起始价 $X → 结束价 $Y（涨跌幅 +Z%）
• 持续 X 个交易日
• 区间成交额 $X 亿（日均 $Y 亿，vs 全历史均值 +Z%）
• 区间换手率 X%（日均 Y%）
• 区间最大单日涨幅 +X%（日期）
• 区间最大单日跌幅 -X%（日期）

阶段特征分析：
[2-3 段话，按「事实→基准→机制→边界」格式论述]

示例：
该阶段日均成交额 8.3 亿港元，为上市初期（首月）日均 3.2 亿的 2.6 倍，显示资金
关注度显著提升。成交额放大主因是 [具体事件]，市场开始将公司定位为 [具体叙事]。
换手率维持在 15-20% 区间，表明筹码处于活跃交换但未达极端状态。这意味着主升浪
仍在延续，但若换手率突破 30% 且涨幅放缓，需警惕进入分歧段。

阶段关键事件：
| 日期 | 事件 | 当日涨跌 | 成交额 | 事件影响分析 |
|------|------|----------|--------|--------------|
| MM-DD | [事件描述] | +X% | $X亿 | [1-2句分析] |

阶段转折点：
• 转折日期：YYYY-MM-DD
• 转折信号：[具体描述，如"放量长上影线，收盘价较日内高点回落 8%"]
• 转折原因：[事件归因或资金行为解读]

────────────────────────────────────────

【阶段 2】YYYY-MM-DD 至 YYYY-MM-DD - [阶段名称]
... [同上格式]

══════════════════════════════════════════════════════════════════════

第三部分：关键交易日深度分析
──────────────────────────────────────────────────────────────────────

**筛选标准：成交额 Top 10 或 换手率 > 30% 或 |涨跌幅| > 15%**

【关键日 1】YYYY-MM-DD

行情数据：
• 开盘 $X → 最高 $H → 最低 $L → 收盘 $C
• 涨跌幅：+X%
• 成交额：$X 亿（为 20 日均值的 Y 倍）
• 换手率：X%

K线形态：[描述，如"放量长阳突破前高"、"高开低走收长上影"]

事件归因：
• 前一日事件：[搜索结果，标注来源]
• 当日事件：[搜索结果，标注来源]
• 归因判断：[事件驱动/板块轮动/资金行为]

资金行为解读：
[按「事实→基准→机制→边界」格式论述该日资金行为的意义]

后续影响：
• 次日表现：+X%
• 5 日后表现：+X%（相对该日收盘）
• 该日对后续走势的意义：[总结]

────────────────────────────────────────

【关键日 2】YYYY-MM-DD
... [同上格式]

══════════════════════════════════════════════════════════════════════

第四部分：资金面量化分析
──────────────────────────────────────────────────────────────────────

一、成交额分布

分位数统计：
• P25：$X 亿/日（低于此为清淡）
• P50：$X 亿/日（正常水平）
• P75：$X 亿/日（活跃）
• P90：$X 亿/日（高度活跃）
• P99：$X 亿/日（极端放量）

成交额趋势（按阶段）：
| 阶段 | 日期范围 | 日均成交额 | vs 前阶段 | 含义 |
|------|----------|------------|-----------|------|
| [阶段1] | [日期] | $X亿 | - | [解读] |
| [阶段2] | [日期] | $X亿 | +Y% | [解读] |

二、换手率分析

累计换手与筹码结构：
• 总累计换手：X%
• 相当于流通盘换手 X 次
• 平均持股周期估算：X 天（= 总交易日 / 换手次数）

极端换手日统计：
| 日期 | 换手率 | 涨跌幅 | 后续走势 | 意义 |
|------|--------|--------|----------|------|
| [日期] | X% | +Y% | [描述] | [顶部/底部/中继] |

换手率与股价关系规律：
[总结换手率极值与股价顶底的历史规律]

三、量价关系

量价配合度时序分析：
| 阶段 | 价格趋势 | 成交额趋势 | 配合度 | 含义 |
|------|----------|------------|--------|------|
| [阶段] | 上涨 | 放量 | 健康 | 资金积极进场 |
| [阶段] | 上涨 | 缩量 | 背离 | 动能减弱 |

关键量价背离点：
[列出所有量价背离点及后续走势，用于验证背离信号有效性]

══════════════════════════════════════════════════════════════════════

第五部分：事件与股价反应归因
──────────────────────────────────────────────────────────────────────

事件时间线（按影响程度排序）：

| 日期 | 事件类型 | 事件内容 | 来源 | 当日涨跌 | 5日累计涨跌 | 事件定性 |
|------|----------|----------|------|----------|-------------|----------|
| [日期] | 公司公告 | [内容] | [来源] | +X% | +Y% | 重大利好 |
| [日期] | 行业事件 | [内容] | [来源] | +X% | +Y% | 催化剂 |
| [日期] | 政策事件 | [内容] | [来源] | -X% | -Y% | 利空 |

事件敏感度分析：
• 对利好事件平均反应：+X%（基于 N 个样本）
• 对利空事件平均反应：-X%（基于 N 个样本）
• 事件效应持续时间：平均 X 个交易日
• 最敏感事件类型：[类型]

核心事件深度解读：

【事件 1】[日期] - [事件标题]

事件内容：
[详细描述，标注来源]

市场反应：
• 当日表现：开盘 +X%，最高 +Y%，收盘 +Z%
• 成交额：$X 亿（vs 前日 +Y%）
• 换手率：X%

反应机制分析：
[按「事实→基准→机制→边界」格式分析市场为何这样反应]

后续演化：
[描述事件后续影响的持续性和衰减]

══════════════════════════════════════════════════════════════════════

第六部分：市场博弈结构分析
──────────────────────────────────────────────────────────────────────

一、主力资金行为推演

建仓阶段推测：
• 推测建仓区间：$X - $Y
• 推测建仓期间：[日期范围]
• 推测依据：[具体数据支持，如"区间换手率达 X%，成交额温和放大但涨幅有限"]
• 推测建仓成本：约 $X（基于 VWAP 或加权平均）

拉升阶段识别：
• 主升区间：$X - $Y
• 主升期间：[日期范围]
• 拉升特征：[具体数据，如"连续 X 日放量突破，日均涨幅 Y%"]

派发阶段识别（如有）：
• 派发区间：$X - $Y
• 派发期间：[日期范围]
• 派发特征：[具体数据，如"高位放量滞涨，换手率达 X% 但涨幅仅 Y%"]

二、散户情绪周期标注

| 阶段 | 时间 | 价格区间 | 推测情绪 | 典型行为 | 判断依据 |
|------|------|----------|----------|----------|----------|
| 怀疑期 | [日期] | $X-$Y | 观望 | 不敢买 | 成交额低迷 |
| 关注期 | [日期] | $X-$Y | 好奇 | 小仓试探 | 成交额温和放大 |
| 追涨期 | [日期] | $X-$Y | FOMO | 追高买入 | 放量上涨 |
| 狂热期 | [日期] | $X-$Y | 极度乐观 | All in | 换手率极端 |
| 恐慌期 | [日期] | $X-$Y | 恐惧 | 割肉 | 放量下跌 |

══════════════════════════════════════════════════════════════════════

第七部分：复盘核心结论
──────────────────────────────────────────────────────────────────────

一、资金特征总结

[3-5 段话，每段按「事实→基准→机制→边界」格式]

总结要点：
1. 这只股票的资金参与特征（机构/游资/散户主导）
2. 成交额和换手率的规律性特征
3. 事件敏感度特征
4. 量价关系规律

二、历史规律提炼

| 规律 | 历史验证 | 有效性 | 应用场景 |
|------|----------|--------|----------|
| 换手率 > X% 见顶 | N 次中 M 次有效 | X% | 判断顶部 |
| 成交额 > P90 持续 N 日后回调 | N 次中 M 次有效 | X% | 减仓信号 |
| [其他规律] | [验证数据] | X% | [应用] |

三、对当前的启示

当前状态：
• 当前阶段：[阶段名称]
• 当前价格：$X（距历史高点 -Y%）
• 当前成交额：$X 亿（vs P50 +Y%）
• 当前换手率：X%

基于历史规律的判断：
[根据历史复盘得出的规律，对当前阶段的判断和后续可能走势的预判]

风险提示：
[基于历史数据的具体风险警示]

══════════════════════════════════════════════════════════════════════

数据来源汇总：
• 行情数据：[来源]，获取日期 YYYY-MM-DD
• 流通市值：[来源]，数据日期 YYYY-MM-DD
• 事件新闻：[列出所有新闻来源]

复盘生成日期：YYYY-MM-DD
此分析基于历史数据，不构成投资建议。过去表现不代表未来收益。

══════════════════════════════════════════════════════════════════════
```

### 每日总结模式（--daily）

```
[股票代码] 每日资金追踪
日期：YYYY-MM-DD

══════════════════════════════════════════════════════════════════════

状态总览
──────────────────────────────────────────────────────────────────────
当前阶段：[MOMENTUM/PARABOLIC_ACCELERATION/DISTRIBUTION/BREAKDOWN/CONSOLIDATION]
资金强度评分：XX/100（计算明细见下）
风险等级：[低/中/高/极高]

──────────────────────────────────────────────────────────────────────

今日行情数据（来源：[来源]）
──────────────────────────────────────────────────────────────────────
开盘：$X | 最高：$H | 最低：$L | 收盘：$C
涨跌幅：+X%
成交额：$X 亿（20日均值 $Y 亿，比值 Z 倍）
换手率：X%（20日均值 Y%，分位数 PXX）
振幅：X%（20日均值 Y%）
距历史高点：-X%

──────────────────────────────────────────────────────────────────────

阶段信号检测
──────────────────────────────────────────────────────────────────────

加速段信号（需满足 ≥3 条）：[当前满足 X/5]
| 条件 | 阈值 | 实际值 | 状态 |
|------|------|--------|------|
| 10日涨幅 | > 120% | X% | ✓/✗ |
| 5日涨幅 | > 50% | X% | ✓/✗ |
| 连续创新高 | ≥ 3日 | X日 | ✓/✗ |
| 成交额 | 60日最高 | 排名第X | ✓/✗ |
| 20日回撤 | < 15% | X% | ✓/✗ |

分歧段信号（需满足 ≥3 条）：[当前满足 X/5]
| 条件 | 阈值 | 实际值 | 状态 |
|------|------|--------|------|
| 振幅扩大 | > 均值×1.5 | X倍 | ✓/✗ |
| 上影线比率 | > 0.6 | X | ✓/✗ |
| 量增价滞 | 成交额新高且涨幅<5% | - | ✓/✗ |
| 收盘弱势 | 连续2日<日高95% | - | ✓/✗ |
| 板块补涨 | 同板块其他股启动 | - | ✓/✗ |

破位段信号（需满足 ≥2 条）：[当前满足 X/3]
| 条件 | 阈值 | 实际值 | 状态 |
|------|------|--------|------|
| 距高点回撤 | > 30% | X% | ✓/✗ |
| 跌破20日均线 | P < MA20 | P=$X, MA20=$Y | ✓/✗ |
| 放量下跌 | 成交额>均值且收跌 | - | ✓/✗ |

──────────────────────────────────────────────────────────────────────

资金强度评分计算明细
──────────────────────────────────────────────────────────────────────
| 维度 | 权重 | 原始值 | 得分 | 计算说明 |
|------|------|--------|------|----------|
| 成交额趋势 | 30% | VR=X | XX分 | 5日均额/20日均额 = X |
| 换手率 | 25% | X% | XX分 | 当日换手率 X% |
| 价格斜率 | 25% | X%/日 | XX分 | 10日线性回归斜率 |
| 创新高频率 | 20% | X/10 | XX分 | 近10日创新高 X 天 |

**总分：XX/100**

──────────────────────────────────────────────────────────────────────

今日事件归因
──────────────────────────────────────────────────────────────────────

搜索结果：
• [来源1]（YYYY-MM-DD）：[事件摘要]
• [来源2]（YYYY-MM-DD）：[事件摘要]

归因判断：
[今日行情主要由 XX 驱动。具体论述...]

──────────────────────────────────────────────────────────────────────

泡沫能量指标
──────────────────────────────────────────────────────────────────────
价格斜率（10日）：X%/日 [上升/下降/持平]
成交额斜率（10日）：X亿/日 [上升/下降/持平]
事件频率（10日）：X 条 [高/中/低]

泡沫状态：[能量增强期/衰退期/破裂期/稳定期]
判断依据：[具体说明]

──────────────────────────────────────────────────────────────────────

执行建议
──────────────────────────────────────────────────────────────────────

【操作建议】
方向：[买入/持有/减仓/清仓/观望]
仓位：X%（上限 Y%）
理由：[2-3 句话，连接当前阶段和具体数据]

【关键价位】
止损位：$X（依据：[如跌破20日均线/回撤15%]）
止盈位：$X（依据：[如前高压力位/涨幅目标]）
加仓位：$X（依据：[如回踩支撑确认]）

【明日关注】
• 关键指标：[如成交额是否萎缩、是否继续创新高]
• 关键事件：[如有已知事件]
• 预警条件：[如换手率超过X%需警惕]

══════════════════════════════════════════════════════════════════════

数据来源：[来源]
此分析基于技术面和资金面，不构成投资建议。

══════════════════════════════════════════════════════════════════════
```

### 综合分析模式（默认）

```
[股票代码] 资金阶段分析
分析日期：YYYY-MM-DD

══════════════════════════════════════════════════════════════════════

一、当前状态判断
──────────────────────────────────────────────────────────────────────

当前阶段：[阶段名称]
资金强度：XX/100
风险等级：[低/中/高/极高]

判断依据：
[按「事实→基准→机制→边界」格式，详细论述为什么判断为该阶段]

二、阶段特征与历史对比
──────────────────────────────────────────────────────────────────────

当前阶段数据：
• 已持续 X 个交易日
• 阶段起点价格 $X，当前 $Y（阶段涨幅 +Z%）
• 阶段日均成交额 $X 亿
• 阶段累计换手率 X%

历史同类阶段对比：
| 历史阶段 | 持续天数 | 涨幅 | 结束方式 |
|----------|----------|------|----------|
| [日期范围] | X天 | +Y% | [转入XX段] |

规律推断：
[基于历史规律，对当前阶段可能的演化路径和持续时间的判断]

三、市场博弈分析
──────────────────────────────────────────────────────────────────────

多头逻辑：
[详细描述当前市场多头的核心假设和押注方向]

空头逻辑：
[详细描述当前市场空头的核心担忧]

当前博弈状态：[多头占优/空头占优/僵持]
判断依据：[具体数据支持]

四、目标区间估算
──────────────────────────────────────────────────────────────────────

| 情景 | 概率 | 目标价 | 触发条件 |
|------|------|--------|----------|
| 乐观 | X% | $X-$Y | [条件] |
| 中性 | X% | $X-$Y | [条件] |
| 悲观 | X% | $X-$Y | [条件] |

五、执行策略
──────────────────────────────────────────────────────────────────────

【策略建议】
当前采取 [建仓/加仓/持有/减仓/清仓/观望] 策略。

【具体操作】
• 方向：[买入/卖出/持有]
• 仓位：X%（上限 Y%）
• 入场区间：$X - $Y
• 止损位：$X（[依据]）
• 止盈位：$X（[依据]）
• 执行节奏：[一次性/分批]

【仓位演化规则】
加仓条件：[具体条件] → 仓位调至 X%
减仓条件：[具体条件] → 仓位调至 X%
清仓条件：[具体条件]

六、风险提示
──────────────────────────────────────────────────────────────────────

• [风险1]：[具体描述，含触发条件和影响]
• [风险2]：[具体描述]
• [风险3]：[具体描述]

下一评估点：[日期/事件]

══════════════════════════════════════════════════════════════════════

数据来源：[来源]
此分析基于技术面和资金面，不构成投资建议。

══════════════════════════════════════════════════════════════════════
```

---

## 执行流程

### 历史复盘模式（--history）

**Step 1：全量数据获取**

```
1. 确定股票代码和上市日期
   搜索: "[公司名] 港股上市日期"

2. 获取全量历史数据
   优先: 使用 AKShare API
   备选: 搜索 "[股票代码] 历史行情 东方财富"

3. 获取流通市值
   搜索: "[股票代码] 流通市值 流通股本"

4. 验证数据完整性
   - 检查数据起始日期是否为上市日
   - 检查是否有缺失交易日
   - 检查数值是否合理
```

**Step 2：数据计算**

```
1. 计算基础指标
   - N日涨跌幅（5/10/20/60日）
   - N日均线（5/10/20/50日）
   - 最大回撤
   - 振幅

2. 计算衍生指标
   - 成交额分位数（P25/P50/P75/P90/P99）
   - 换手率分位数
   - 累计换手率
   - 价格斜率、成交额斜率

3. 识别关键交易日
   - 成交额 Top 10
   - 换手率 > 30%
   - |涨跌幅| > 15%
   - 创历史新高日
```

**Step 3：阶段划分**

```
1. 按时间顺序遍历每个交易日
2. 计算当日的阶段信号分数
3. 判断阶段类型
4. 识别阶段转折点
5. 汇总阶段列表
```

**Step 4：事件归因**

```
对每个关键交易日执行：

1. 搜索当日新闻
   "[公司名] [日期]" site:cls.cn
   "[公司名] [日期]" site:wallstreetcn.com

2. 搜索前一日新闻（盘后消息）
   "[公司名] [前一日日期]" site:hkexnews.hk

3. 搜索行业事件
   "AI 大模型 [日期]" site:36kr.com

4. 归因判断
   - 有明确事件 → 标注事件
   - 无明确事件 → 标注"资金行为"或"板块轮动"
```

**Step 5：生成报告**

按输出格式生成完整复盘报告，确保：
- 每个论述都有数据支持
- 每个数据都有来源标注
- 每个结论都有边界说明

---

## 港股代码对照

| 公司 | 代码 | 板块 |
|------|------|------|
| 商汤 | 00020.HK | AI 算力 |
| 第四范式 | 06682.HK | AI 平台 |
| 百度 | 09888.HK | AI 大模型 |
| 阿里 | 09988.HK | AI 云计算 |
| 腾讯 | 00700.HK | AI 应用 |
| 金山云 | 03896.HK | AI 云计算 |
| 金蝶 | 00268.HK | AI 企业服务 |

**输入格式：** 支持纯数字（00020）或带后缀（00020.HK）

---

## 质量检查清单

### 每段论述必须检查：
- [ ] 是否有具体数字？（事实）
- [ ] 是否有对比基准？（基准）
- [ ] 是否解释了原因？（机制）
- [ ] 是否说明了结论边界？（边界）
- [ ] 是否标注了数据来源？

### 每个计算必须检查：
- [ ] 公式是否正确应用？
- [ ] 输入数据是否经过验证？
- [ ] 计算结果是否合理？
- [ ] 是否有交叉验证？

### 每个归因必须检查：
- [ ] 是否搜索了多个来源？
- [ ] 事件与股价变动是否有因果关系？
- [ ] 是否排除了其他可能原因？
- [ ] 若无明确事件是否如实标注？

### 禁止项：
- 编造数据
- 无来源引用
- 无依据结论
- 模糊表述（"大幅"、"显著"等不带数字）
- 超过 5 个并列 bullet point 不分组
